name: "Test and Deploy"

on:
   push:
jobs:
   build:
      name: "Build and Test App"
      runs-on: ubuntu-latest
      steps:
         - uses: actions/checkout@v2
         - uses: actions/setup-node@v2
           with:
              node-version: "14.x"
         - name: Cache multiple paths
           uses: actions/cache@v3
           with:
              path: |
                 ~/cache
                 !~/cache/exclude
              key: ${{ runner.os }}-${{ hashFiles('**/lockfiles') }}
         - name: cache node_modules
           uses: actions/cache@v3
           with:
              key: ${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
              path: |
                 node_modules
         - name: Cache Vercel
           uses: actions/cache@v3
           with:
              # See here for caching with `yarn` https://github.com/actions/cache/blob/main/examples.md#node---yarn or you can leverage caching with actions/setup-node https://github.com/actions/setup-node
              path: |
                 ~/.npm
                 ${{ github.workspace }}/.next/cache
              # Generate a new cache whenever packages or source files change.
              key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
              # If source files changed but packages didn't, rebuild from a prior cache.
              restore-keys: |
                 ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
         - name: install latest npm
           run: |
              npm install -g npm@8.5.5 &&
              npm --version &&
              npm list -g --depth 0
         - name: Install dependencies
           run: npm install
         - name: Build
           env:
              SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
           run: npm run build
         - name: Run Jest Unit Tests
           run: npm run test
         - name: Install Playwright
           run: npx playwright install --with-deps
         - name: Run Playwright End to End tests
           env:
              FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN}}
           run: npm run test:e2e
         - name: Deploy to Vercel
           uses: amondnet/vercel-action@v20 #deploy
           with:
              vercel-token: ${{ secrets.VERCEL_TOKEN }} # Required
              github-token: ${{ secrets.GITHUB_TOKEN }} #Optional
              vercel-org-id: ${{ secrets.VERCEL_ORG_ID}} #Required
              vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID}} #Required
