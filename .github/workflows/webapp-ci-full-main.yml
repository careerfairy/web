name: "Build, Test and Deploy"
on:
   # Triggers on pushes targeting these branches
   push:
      branches:
         - main
         - develop
         # we almost never use the staging env, no need to waste
         # minutes by deploying there every time if we don't use it

   # Triggers on opened/reopened PRs
   pull_request:

   # Allow manually trigger the CI in github
   workflow_dispatch:

env:
   # https://turborepo.org/docs/guides/continuous-integration
   TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
   TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
   NEXT_PUBLIC_TALENT_GUIDE_HYGRAPH_URL: ${{ secrets.NEXT_PUBLIC_TALENT_GUIDE_HYGRAPH_URL }}
   HYGRAPH_TALENT_GUIDE_PROD_TOKEN: ${{ secrets.HYGRAPH_TALENT_GUIDE_PROD_TOKEN }}
   HYGRAPH_TALENT_GUIDE_PREVIEW_TOKEN: ${{ secrets.HYGRAPH_TALENT_GUIDE_PREVIEW_TOKEN }}

# Ensures that only one deploy task per branch will run at a time (cancels old commit runs)
concurrency:
   group: ${{ github.head_ref || github.ref_name }}
   cancel-in-progress: true

jobs:
   optimize_ci:
      runs-on: ubuntu-latest
      outputs:
         skip: ${{ steps.check_skip.outputs.skip }}
      steps:
         - name: Optimize CI
           id: check_skip
           uses: withgraphite/graphite-ci-action@main
           with:
              graphite_token: ${{ secrets.GRAPHITE_TOKEN }}

   build_app_for_tests:
      name: "Pre-build cache for tests"
      needs: optimize_ci
      if: needs.optimize_ci.outputs.skip == 'false'
      runs-on: ubuntu-latest
      timeout-minutes: 15
      outputs:
         webapp: ${{ steps.changes.outputs.webapp }}
         shared-lib: ${{ steps.changes.outputs.shared-lib }}
         shared-ui: ${{ steps.changes.outputs.shared-ui }}
         config-mui: ${{ steps.changes.outputs.config-mui }}
         workflow: ${{ steps.changes.outputs.workflow }}
      steps:
         - uses: actions/checkout@v4
         - uses: pnpm/action-setup@v4
           with:
              version: 9.15.9

         - name: Get pnpm store directory
           shell: bash
           run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

         - name: Cache pnpm store
           uses: actions/cache@v4
           with:
              path: ${{ env.STORE_PATH }}
              key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
              restore-keys: |
                 ${{ runner.os }}-pnpm-store-

         - uses: actions/setup-node@v4
           with:
              node-version: "22"

         - name: Install Dependencies
           run: pnpm install --frozen-lockfile --ignore-scripts

         - name: Cache .next/cache folder
           uses: actions/cache@v4
           with:
              path: ${{ github.workspace }}/apps/web/.next/cache
              key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('apps/web/**/*.[jt]s', 'apps/web/**/*.[jt]sx', 'packages/**/*.[jt]s', 'packages/**/*.[jt]sx') }}
              # If source files changed but packages didn't, rebuild from a prior cache.
              restore-keys: |
                 ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-
                 ${{ runner.os }}-nextjs-

         - name: Build
           run: pnpm run build
           env:
              SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
              NODE_ENV: test
              NODE_OPTIONS: --max-old-space-size=4096

         - name: Cache build artifacts
           uses: actions/cache/save@v4
           with:
              path: |
                 ${{ github.workspace }}/apps/web/.next
                 ${{ github.workspace }}/packages/*/dist
                 ${{ github.workspace }}/.turbo
                 ${{ github.workspace }}/apps/*/.turbo
                 ${{ github.workspace }}/packages/*/.turbo
              key: ${{ runner.os }}-build-${{ github.sha }}

         # Check which folders have changed
         # So that we can skip future jobs
         - uses: dorny/paths-filter@v3
           id: changes
           with:
              base: main
              filters: |
                 workflow:
                  - '.github/workflows/webapp-ci-full-main.yml'
                 webapp:
                   - 'apps/web/**'
                   - 'packages/shared-lib/**'
                   - 'packages/shared-ui/**'
                   - 'packages/config-mui/**'
                   - 'packages/seed-data/**'
                 shared-lib:
                   - 'packages/shared-lib/**'

   # Run Unit Tests
   unit_tests:
      name: "Unit Tests"
      needs: [build_app_for_tests]
      # only run if there are changes on the webapp & shared lib
      if: |
         needs.build_app_for_tests.outputs.webapp == 'true' ||
         needs.build_app_for_tests.outputs.shared-lib == 'true' ||
         needs.build_app_for_tests.outputs.shared-ui == 'true' ||
         needs.build_app_for_tests.outputs.config-mui == 'true' ||
         needs.build_app_for_tests.outputs.workflow == 'true'
      runs-on: ubuntu-latest
      timeout-minutes: 10
      env:
         SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
         NODE_ENV: test
      steps:
         - uses: actions/checkout@v4
         - uses: pnpm/action-setup@v4
           with:
              version: 9.15.9

         - name: Get pnpm store directory
           shell: bash
           run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

         - name: Cache pnpm store
           uses: actions/cache@v4
           with:
              path: ${{ env.STORE_PATH }}
              key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
              restore-keys: |
                 ${{ runner.os }}-pnpm-store-

         - uses: actions/setup-node@v4
           with:
              node-version: "22"

         - name: Install Dependencies
           run: pnpm install --frozen-lockfile

         - name: Restore build artifacts
           uses: actions/cache/restore@v4
           with:
              path: |
                 ${{ github.workspace }}/apps/web/.next
                 ${{ github.workspace }}/packages/*/dist
                 ${{ github.workspace }}/.turbo
                 ${{ github.workspace }}/apps/*/.turbo
                 ${{ github.workspace }}/packages/*/.turbo
              key: ${{ runner.os }}-build-${{ github.sha }}

         - name: Run Jest Unit Tests
           run: pnpm run test

   # Run E2E Tests
   e2e_tests:
      name: E2E Tests - ${{ matrix.shard }}/${{ matrix.total }}
      needs: [build_app_for_tests]
      # only run if there are changes on the webapp & shared lib
      if: |
         needs.build_app_for_tests.outputs.webapp == 'true' ||
         needs.build_app_for_tests.outputs.shared-lib == 'true' ||
         needs.build_app_for_tests.outputs.shared-ui == 'true' ||
         needs.build_app_for_tests.outputs.config-mui == 'true' ||
         needs.build_app_for_tests.outputs.workflow == 'true'
      strategy:
         fail-fast: false
         matrix:
            shard: [1, 2, 3, 4, 5]
            total: [5]
      runs-on: ubuntu-22.04
      timeout-minutes: 25
      steps:
         - uses: actions/checkout@v4
         - uses: pnpm/action-setup@v4
           with:
              version: 9.15.9

         - name: Get pnpm store directory
           shell: bash
           run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

         - name: Cache pnpm store
           uses: actions/cache@v4
           with:
              path: ${{ env.STORE_PATH }}
              key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
              restore-keys: |
                 ${{ runner.os }}-pnpm-store-

         - uses: actions/setup-node@v4
           with:
              node-version: "22"

         - name: Install Dependencies
           run: pnpm install --frozen-lockfile

         - name: Cache Firebase Emulators
           uses: actions/cache@v4
           with:
              path: ~/.cache/firebase/emulators
              key: ${{ runner.os }}-firebase-emulators-${{ hashFiles('**/pnpm-lock.yaml') }}
              restore-keys: |
                 ${{ runner.os }}-firebase-emulators-

         - name: Restore build artifacts
           id: restore-build
           uses: actions/cache/restore@v4
           with:
              path: |
                 ${{ github.workspace }}/apps/web/.next
                 ${{ github.workspace }}/packages/*/dist
                 ${{ github.workspace }}/.turbo
                 ${{ github.workspace }}/apps/*/.turbo
                 ${{ github.workspace }}/packages/*/.turbo
              key: ${{ runner.os }}-build-${{ github.sha }}

         - name: Install Playwright's dependencies
           run: pnpm --filter @careerfairy/webapp exec playwright install --with-deps

         - name: Build webapp and dependencies for E2E (only if cache miss)
           if: steps.restore-build.outputs.cache-hit != 'true'
           env:
              NODE_ENV: test
              NODE_OPTIONS: --max-old-space-size=4096
           run: pnpm run build
         - name: Install uuid-runtime
           run: sudo apt-get install uuid-runtime
         - name: Generate UUID
           run: echo "UNIQUE_UUID=$(uuidgen)-${{ matrix.shard }}" >> $GITHUB_ENV
         - name: Run Playwright End to End tests
           env:
              SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
              NEXT_PUBLIC_UNIQUE_WORKFLOW_ID: ${{ env.UNIQUE_UUID }}
              NODE_ENV: test
              NODE_OPTIONS: --max-old-space-size=4096
           run: pnpm run test:e2e-webapp -- --shard=${{ matrix.shard }}/${{ matrix.total }}

         - name: Upload test results
           if: ${{ failure() }}
           uses: actions/upload-artifact@v4
           with:
              name: ${{ matrix.shard }}-playwright-report
              path: apps/web/playwright-report
              retention-days: 30

         - name: Upload debug logs
           if: ${{ failure() }}
           uses: actions/upload-artifact@v4
           with:
              name: ${{ matrix.shard }}-debug-logs
              path: firebase-debug.log
              retention-days: 30

   # Deploy
   deploy:
      name: "Deploy"
      needs: [unit_tests, e2e_tests]
      runs-on: ubuntu-latest
      timeout-minutes: 20
      steps:
         - uses: actions/checkout@v4
         - name: Install Vercel CLI
           run: npm install --global vercel@latest
         - name: Deploy to Vercel
           uses: BetaHuhn/deploy-to-vercel-action@v1.10.0
           id: vercel-deploy
           with:
              VERCEL_SCOPE: careerfairy-ssr
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
              VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
              VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
              PRODUCTION: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'true' || 'false' }}
              PR_LABELS: false
              ALIAS_DOMAINS: ${{ ( github.event_name == 'push' && github.ref == 'refs/heads/develop' && 'staging.careerfairy.io' ) || '' }}
              DELETE_EXISTING_COMMENT: true
              PR_PREVIEW_DOMAIN: "careerfairy-ssr-webapp-pr-{PR}.vercel.app"
         - name: preview-url
           run: |
              echo ${{ steps.vercel-deploy.outputs.PREVIEW_URL }}
