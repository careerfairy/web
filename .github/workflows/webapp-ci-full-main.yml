name: "Build, Test and Deploy"
on:
   # Triggers on pushes targeting these branches
   push:
      branches:
         - main
         - develop
         # we almost never use the staging env, no need to waste
         # minutes by deploying there every time if we don't use it

   # Triggers on opened/reopened PRs
   pull_request:

   # Allow manually trigger the CI in github
   workflow_dispatch:

env:
   # https://turborepo.org/docs/guides/continuous-integration
   TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
   TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

# Ensures that only one deploy task per branch will run at a time (cancels old commit runs)
concurrency:
   group: ${{ github.head_ref || github.ref_name }}
   cancel-in-progress: true

jobs:
   build_app_for_tests:
      name: "Pre-build cache for tests"
      runs-on: ubuntu-latest
      timeout-minutes: 10
      outputs:
         webapp: ${{ steps.changes.outputs.webapp }}
         shared-lib: ${{ steps.changes.outputs.shared-lib }}
         streaming: ${{ steps.changes.outputs.streaming }}
         workflow: ${{ steps.changes.outputs.workflow }}
      steps:
         - uses: actions/checkout@v3
         - uses: actions/setup-node@v3
           with:
              node-version: "18"
         - name: Cache node modules
           id: cache-nodemodules
           uses: actions/cache@v3
           with:
              path: "**/node_modules"
              key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
         - name: Install Dependencies
           if: steps.cache-nodemodules.outputs.cache-hit != 'true'
           run: npm ci --ignore-scripts

         - name: Cache .next/cache folder
           uses: actions/cache@v3
           with:
              path: ${{ github.workspace }}/apps/web/.next/cache
              key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
              # If source files changed but packages didn't, rebuild from a prior cache.
              restore-keys: |
                 ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-

         - name: Build
           run: npm run build
           env:
              SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
              NODE_ENV: test
              NEXT_PUBLIC_PROD_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_PROD_FIREBASE_API_KEY }}
              NEXT_PUBLIC_PROD_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_PROD_FIREBASE_AUTH_DOMAIN }}
              NEXT_PUBLIC_PROD_FIREBASE_DATABASE_URL: ${{ secrets.NEXT_PUBLIC_PROD_FIREBASE_DATABASE_URL }}
              NEXT_PUBLIC_PROD_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_PROD_FIREBASE_PROJECT_ID }}
              NEXT_PUBLIC_PROD_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_PROD_FIREBASE_STORAGE_BUCKET }}
              NEXT_PUBLIC_PROD_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_PROD_FIREBASE_MESSAGING_SENDER_ID }}
              NEXT_PRIVATE_PROD_POSTMARK_SERVER_TOKEN: ${{ secrets.NEXT_PRIVATE_PROD_POSTMARK_SERVER_TOKEN }}
              NEXT_PRIVATE_DEV_POSTMARK_SERVER_TOKEN: ${{ secrets.NEXT_PRIVATE_DEV_POSTMARK_SERVER_TOKEN }}
              NEXT_PRIVATE_PROD_AGORA_APP_ID: ${{ secrets.NEXT_PRIVATE_PROD_AGORA_APP_ID }}
              NEXT_PRIVATE_DEV_AGORA_APP_CERTIFICATE: ${{ secrets.NEXT_PRIVATE_DEV_AGORA_APP_CERTIFICATE }}
              NEXT_PRIVATE_DEV_AGORA_CUSTOMER_KEY: ${{ secrets.NEXT_PRIVATE_DEV_AGORA_CUSTOMER_KEY }}
              NEXT_PRIVATE_DEV_AGORA_CUSTOMER_SECRET: ${{ secrets.NEXT_PRIVATE_DEV_AGORA_CUSTOMER_SECRET }}
              NEXT_PRIVATE_PROD_AWS_SECRET_KEY: ${{ secrets.NEXT_PRIVATE_PROD_AWS_SECRET_KEY }}
              NEXT_PRIVATE_PROD_AWS_ACCESS_KEY: ${{ secrets.NEXT_PRIVATE_PROD_AWS_ACCESS_KEY }}

         # Check which folders have changed
         # So that we can skip future jobs
         - uses: dorny/paths-filter@v2
           id: changes
           with:
              base: main
              filters: |
                 workflow:
                  - '.github/workflows/webapp-ci-full-main.yml'
                 webapp:
                   - 'apps/web/**'
                   - 'packages/shared-lib/**'
                   - 'packages/seed-data/**'
                 shared-lib:
                   - 'packages/shared-lib/**'
                 streaming: 
                   - 'apps/streaming/**'
                   - 'packages/shared-lib/**'
                   - 'packages/shared-ui/**'

   # Run Unit Tests
   unit_tests:
      name: "Unit Tests"
      needs: [build_app_for_tests]
      # only run if there are changes on the webapp & shared lib
      if: |
         needs.build_app_for_tests.outputs.webapp == 'true' ||
         needs.build_app_for_tests.outputs.shared-lib == 'true' ||
         needs.build_app_for_tests.outputs.workflow == 'true' ||
         needs.build_app_for_tests.outputs.streaming == 'true'
      runs-on: ubuntu-latest
      timeout-minutes: 10
      env:
         SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
         NODE_ENV: test
      steps:
         - uses: actions/checkout@v3
         - uses: actions/setup-node@v3
           with:
              node-version: "18"
         - name: Cache node modules
           id: cache-nodemodules
           uses: actions/cache@v3
           with:
              path: "**/node_modules"
              key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
         - name: Install Dependencies
           if: steps.cache-nodemodules.outputs.cache-hit != 'true'
           run: npm ci --ignore-scripts

         - name: Run Jest Unit Tests
           run: npm run test

   # Run E2E Tests
   e2e_tests:
      name: E2E Tests - ${{ matrix.shard }}/${{ matrix.total }}
      needs: [build_app_for_tests]
      # only run if there are changes on the webapp & shared lib
      if: |
         needs.build_app_for_tests.outputs.webapp == 'true' ||
         needs.build_app_for_tests.outputs.shared-lib == 'true' ||
         needs.build_app_for_tests.outputs.workflow == 'true'
      strategy:
         fail-fast: false
         matrix:
            shard: [1, 2, 3, 4, 5]
            total: [5]
      runs-on: ubuntu-22.04
      timeout-minutes: 25
      steps:
         - uses: actions/checkout@v3
         - uses: actions/setup-node@v3
           with:
              node-version: "18"
         - name: Cache node modules
           id: cache-nodemodules
           uses: actions/cache@v3
           with:
              path: "**/node_modules"
              key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
         - name: Install Dependencies
           if: steps.cache-nodemodules.outputs.cache-hit != 'true'
           run: npm ci --ignore-scripts

         - name: Install Playwright's dependencies
           run: npx playwright install --with-deps

         - name: Run Playwright End to End tests
           env:
              SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
              NODE_ENV: test
           run: npm run test:e2e-webapp -- -- --shard=${{matrix.shard}}/${{ matrix.total }}

         - name: Upload test results
           if: ${{ failure() }}
           uses: actions/upload-artifact@v3
           with:
              name: ${{ matrix.shard }}-playwright-report
              path: apps/web/playwright-report
              retention-days: 30

         - name: Upload debug logs
           if: ${{ failure() }}
           uses: actions/upload-artifact@v3
           with:
              name: ${{ matrix.shard }}-debug-logs
              path: firebase-debug.log
              retention-days: 30

   # Deploy
   deploy:
      name: "Deploy"
      needs: [e2e_tests, unit_tests]
      runs-on: ubuntu-latest
      timeout-minutes: 20
      steps:
         - uses: actions/checkout@v3
         - name: Deploy to Vercel
           uses: BetaHuhn/deploy-to-vercel-action@v1
           id: vercel-deploy
           with:
              VERCEL_SCOPE: careerfairy-ssr
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
              VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
              VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
              PRODUCTION: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'true' || 'false' }}
              PR_LABELS: false
              ALIAS_DOMAINS: ${{ ( github.event_name == 'push' && github.ref == 'refs/heads/develop' && 'staging.careerfairy.io' ) || '' }}
              DELETE_EXISTING_COMMENT: false
         - name: preview-url
           run: |
              echo ${{ steps.vercel-deploy.outputs.PREVIEW_URL }}
   deploy_streaming:
      name: "Deploy Streaming"
      needs: [unit_tests]
      if: needs.build_app_for_tests.outputs.streaming == 'true'
      runs-on: ubuntu-latest
      timeout-minutes: 20
      steps:
         - uses: actions/checkout@v3
         - name: Deploy to Vercel
           uses: BetaHuhn/deploy-to-vercel-action@v1
           id: vercel-deploy
           with:
              VERCEL_SCOPE: careerfairy-ssr
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
              VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
              VERCEL_PROJECT_ID: ${{ secrets.VERCEL_STREAMING_PROJECT_ID }} # replace with the project ID of the streaming app
              PRODUCTION: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'true' || 'false' }}
              PR_LABELS: false
              DELETE_EXISTING_COMMENT: false
         - name: preview-url
           run: |
              echo ${{ steps.vercel-deploy.outputs.PREVIEW_URL }}
